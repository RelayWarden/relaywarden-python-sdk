name: Release

on:
  release:
    types: [created]

permissions:
  contents: read
  id-token: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    environment:
      name: pypi
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0
      - name: Extract version from release tag
        id: version
        run: |
          # Remove 'v' prefix if present (e.g., v1.2.3 -> 1.2.3)
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG_NAME"
          echo "Release version: $VERSION"
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      - name: Update pyproject.toml version
        run: |
          python -c "
          import re
          import sys
          version = '${{ steps.version.outputs.version }}'
          with open('pyproject.toml', 'r') as f:
              content = f.read()
          content = re.sub(r'^version = \"[^\"]+\"', f'version = \"{version}\"', content, flags=re.MULTILINE)
          with open('pyproject.toml', 'w') as f:
              f.write(content)
          "
      - name: Build release distributions
        run: python -m build
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.13.0
